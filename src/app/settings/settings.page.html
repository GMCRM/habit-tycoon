<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>⚙️ Settings</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" [scrollY]="false">
  <div class="scrollable-content">
    <div class="settings-content">
      <!-- Profile Settings Card -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="person"></ion-icon>
            Profile Settings
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div
            class="form-field"
            [class.has-error]="!username.trim() && username !== ''"
          >
            <ion-item>
              <ion-label position="stacked">Username</ion-label>
              <ion-input
                [(ngModel)]="username"
                placeholder="Enter your username"
                type="text"
                maxlength="30"
              >
              </ion-input>
            </ion-item>
            <div
              class="validation-error"
              *ngIf="!username.trim() && username !== ''"
            >
              Username is required
            </div>
          </div>

          <ion-button
            expand="block"
            (click)="updateProfile()"
            [disabled]="isUpdatingProfile || !username.trim()"
            color="primary"
            [class.loading-button]="isUpdatingProfile"
          >
            <ion-icon name="save" slot="start"></ion-icon>
            {{ isUpdatingProfile ? 'Updating...' : 'Update Profile' }}
          </ion-button>
        </ion-card-content>
      </ion-card>

      <!-- Password Settings Card - Only show for email/password users -->
      <ion-card *ngIf="!isGoogleUser">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="lock-closed"></ion-icon>
            Change Password
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="form-field">
            <ion-item>
              <ion-label position="stacked">New Password</ion-label>
              <ion-input
                [(ngModel)]="newPassword"
                placeholder="Enter new password"
                type="password"
                maxlength="100"
              >
              </ion-input>
            </ion-item>
          </div>

          <div
            class="form-field"
            [class.has-error]="newPassword !== confirmPassword && confirmPassword !== ''"
          >
            <ion-item>
              <ion-label position="stacked">Confirm New Password</ion-label>
              <ion-input
                [(ngModel)]="confirmPassword"
                placeholder="Confirm new password"
                type="password"
                maxlength="100"
              >
              </ion-input>
            </ion-item>
            <div
              class="validation-error"
              *ngIf="newPassword !== confirmPassword && confirmPassword !== ''"
            >
              Passwords do not match
            </div>
          </div>

          <ion-button
            expand="block"
            (click)="updatePassword()"
            [disabled]="isUpdatingPassword || !newPassword || !confirmPassword || newPassword !== confirmPassword"
            color="secondary"
            [class.loading-button]="isUpdatingPassword"
          >
            <ion-icon name="save" slot="start"></ion-icon>
            {{ isUpdatingPassword ? 'Updating...' : 'Update Password' }}
          </ion-button>
        </ion-card-content>
      </ion-card>

      <!-- Google Account Info Card - Only show for Google users -->
      <ion-card *ngIf="isGoogleUser" class="google-info-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="logo-google"></ion-icon>
            Google Account
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="google-info">
            <p class="google-message">
              You're signed in with your Google account. Your password is
              managed by Google, so you can't change it here.
            </p>
            <p class="google-tip">
              To update your password, visit your
              <a
                href="https://myaccount.google.com/security"
                target="_blank"
                class="google-link"
              >
                Google Account Security settings </a
              >.
            </p>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Danger Zone Card -->
      <ion-card class="danger-zone-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="warning"></ion-icon>
            Danger Zone
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="danger-info">
            <p class="danger-message">
              Permanently delete your account and all associated data. This
              action cannot be undone.
            </p>
          </div>

          <ion-button
            expand="block"
            color="danger"
            fill="outline"
            (click)="showDeleteProfileConfirmation()"
            [disabled]="isDeletingProfile"
          >
            <ion-icon name="trash" slot="start"></ion-icon>
            Delete Account
          </ion-button>
        </ion-card-content>
      </ion-card>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <ion-modal
    [isOpen]="showDeleteConfirmation"
    (willDismiss)="cancelDeleteProfile()"
  >
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Confirm Account Deletion</ion-title>
          <ion-button slot="end" fill="clear" (click)="cancelDeleteProfile()"
            >Cancel</ion-button
          >
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div class="delete-confirmation">
          <div class="warning-section">
            <ion-icon name="warning" color="danger"></ion-icon>
            <h2>Are you absolutely sure?</h2>
            <p>
              This will permanently delete your account and all associated data
              including:
            </p>
            <ul>
              <li>Your profile and personal information</li>
              <li>All habit businesses and progress</li>
              <li>Your stock portfolio and investments</li>
              <li>Social connections and friendships</li>
              <li>All financial data and achievements</li>
            </ul>
            <p class="final-warning">
              <strong>This action cannot be undone.</strong>
            </p>
          </div>

          <div class="confirmation-input">
            <ion-item>
              <ion-label position="stacked">
                Type <strong>DELETE</strong> to confirm:
              </ion-label>
              <ion-input
                [(ngModel)]="deleteConfirmationText"
                placeholder="Type DELETE here"
                type="text"
                maxlength="10"
              >
              </ion-input>
            </ion-item>
          </div>

          <div class="action-buttons">
            <ion-button
              expand="block"
              fill="outline"
              color="medium"
              (click)="cancelDeleteProfile()"
              [disabled]="isDeletingProfile"
            >
              Cancel
            </ion-button>

            <ion-button
              expand="block"
              color="danger"
              (click)="confirmDeleteProfile()"
              [disabled]="isDeletingProfile || deleteConfirmationText.toLowerCase() !== 'delete'"
              [class.loading-button]="isDeletingProfile"
            >
              <ion-icon name="trash" slot="start"></ion-icon>
              {{ isDeletingProfile ? 'Deleting...' : 'Delete Forever' }}
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Toast for feedback messages -->
  <ion-toast
    [isOpen]="showToast"
    [message]="toastMessage"
    [duration]="3000"
    [color]="toastColor"
    [class]="'toast-' + toastColor"
    (didDismiss)="showToast = false"
  >
  </ion-toast>
</ion-content>

<!-- Bottom Navigation -->
<app-bottom-nav mainButton="home"></app-bottom-nav>
